<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selah - 專案甘特圖</title>
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #475569;
      --accent: #6366f1;
      --today: #f59e0b;
      --cell-width: 21px;
      --row-height: 22px;
      --group-col-width: 60px;
      --task-col-width: 120px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.67rem;
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo h1 {
      font-size: 1rem;
      font-weight: 600;
    }

    .logo .subtitle {
      color: var(--text-secondary);
      font-size: 0.6rem;
    }

    .nav-tabs {
      display: flex;
      gap: 0.3rem;
    }

    .nav-tab {
      padding: 0.3rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 0.3rem;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.6rem;
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 0.6rem;
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .control-group label {
      color: var(--text-secondary);
      font-size: 0.6rem;
    }

    select {
      padding: 0.2rem 0.4rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.6rem;
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Main Container */
    .main-container {
      height: calc(100vh - 70px);
      overflow: auto;
    }

    /* Gantt Table */
    .gantt-table {
      border-collapse: collapse;
      table-layout: fixed;
    }

    .gantt-table th,
    .gantt-table td {
      border: 1px solid var(--border-color);
      height: var(--row-height);
      vertical-align: middle;
      text-align: center;
    }

    /* Header row */
    .gantt-table thead {
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .gantt-table thead th {
      background: var(--bg-tertiary);
      font-weight: 600;
      font-size: 0.5rem;
      padding: 2px;
    }

    .gantt-table thead th.col-group {
      width: var(--group-col-width);
      min-width: var(--group-col-width);
    }

    .gantt-table thead th.col-task {
      width: var(--task-col-width);
      min-width: var(--task-col-width);
    }

    .gantt-table thead th.col-day {
      width: var(--cell-width);
      min-width: var(--cell-width);
    }

    .day-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.1;
    }

    .day-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .day-num {
      font-size: 0.4rem;
      color: var(--text-secondary);
    }

    .col-day.weekend {
      background: rgba(255, 255, 255, 0.03);
    }

    .col-day.today {
      background: rgba(245, 158, 11, 0.2);
    }

    .col-day.today .day-name {
      color: var(--today);
    }

    /* Group cell (merged) */
    .cell-group {
      background: var(--bg-tertiary);
      font-size: 0.5rem;
      font-weight: 600;
      color: var(--text-secondary);
      writing-mode: vertical-rl;
      text-orientation: mixed;
      padding: 4px 2px;
      width: var(--group-col-width);
      min-width: var(--group-col-width);
    }

    .group-label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .group-color-bar {
      width: 3px;
      height: 100%;
      min-height: 12px;
      border-radius: 1px;
    }

    /* Task cell */
    .cell-task {
      background: var(--bg-secondary);
      text-align: left;
      padding: 0 6px;
      font-size: 0.55rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: var(--task-col-width);
      min-width: var(--task-col-width);
    }

    .cell-task .task-content {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-color-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .task-status {
      font-size: 0.45rem;
    }

    .task-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .cell-task.completed {
      opacity: 0.6;
    }

    .cell-task.completed .task-name {
      text-decoration: line-through;
    }

    /* Day cells */
    .cell-day {
      background: var(--bg-primary);
      position: relative;
      width: var(--cell-width);
      min-width: var(--cell-width);
      padding: 0;
    }

    .cell-day.weekend {
      background: rgba(255, 255, 255, 0.02);
    }

    .cell-day.today {
      background: rgba(245, 158, 11, 0.1);
    }

    /* Task Bar */
    .task-bar {
      position: absolute;
      top: 2px;
      height: calc(var(--row-height) - 6px);
      border-radius: 3px;
      display: flex;
      align-items: center;
      padding: 0 4px;
      font-size: 0.45rem;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      z-index: 5;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      cursor: pointer;
    }

    .task-bar.completed {
      opacity: 0.7;
    }

    .task-bar.background {
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 3px,
        rgba(255,255,255,0.15) 3px,
        rgba(255,255,255,0.15) 6px
      );
    }

    .milestone {
      position: absolute;
      top: 50%;
      width: 10px;
      height: 10px;
      transform: rotate(45deg) translate(-50%, -50%);
      transform-origin: top left;
      background: var(--today);
      z-index: 6;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Week View */
    .week-view .col-day,
    .week-view .cell-day {
      width: 80px;
      min-width: 80px;
    }

    .week-view thead th.col-day {
      width: 80px;
      min-width: 80px;
    }

    .week-view .day-header {
      padding: 4px;
    }

    .week-view .day-name {
      font-size: 0.55rem;
    }

    .week-view .day-num {
      font-size: 0.5rem;
    }

    /* Year Week Mode */
    .year-week-view .col-day,
    .year-week-view .cell-day {
      width: 16px;
      min-width: 16px;
    }

    .year-week-view thead th.col-day {
      width: 16px;
      min-width: 16px;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 0.3rem;
      padding: 0.5rem;
      font-size: 0.55rem;
      max-width: 200px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      display: none;
    }

    .tooltip.visible {
      display: block;
    }

    .tooltip-title {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.15rem;
      color: var(--text-secondary);
    }

    .tooltip-row span:last-child {
      color: var(--text-primary);
    }

    /* Footer */
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 1rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      font-size: 0.5rem;
      position: sticky;
      bottom: 0;
    }

    .legend {
      display: flex;
      gap: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--text-secondary);
    }

    .legend-color {
      width: 12px;
      height: 6px;
      border-radius: 2px;
    }

    .legend-stripe {
      width: 12px;
      height: 6px;
      border-radius: 2px;
      background: #3b82f6;
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 2px,
        rgba(255,255,255,0.3) 2px,
        rgba(255,255,255,0.3) 4px
      );
    }

    .legend-milestone {
      width: 6px;
      height: 6px;
      transform: rotate(45deg);
      background: var(--today);
    }

    .sponsor {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .sponsor span {
      color: var(--text-secondary);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-color);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <h1>Selah</h1>
      <span class="subtitle">סֶלָה — 停下，思考，再前行</span>
    </div>
    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="year">全年甘特圖</button>
      <button class="nav-tab" data-view="week">周甘特圖</button>
    </nav>
  </header>

  <div class="controls">
    <div class="control-group" id="year-controls">
      <label>顯示：</label>
      <select id="display-mode">
        <option value="day">按天</option>
        <option value="week">按周</option>
      </select>
    </div>
    <div class="control-group" id="week-selector" style="display: none;">
      <label>選擇周：</label>
      <select id="week-select"></select>
    </div>
    <div class="control-group">
      <label>今天：</label>
      <span id="today-display">2026-01-18</span>
    </div>
  </div>

  <div class="main-container">
    <table class="gantt-table" id="gantt-table"></table>
  </div>

  <div class="footer">
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #3b82f6;"></div>
        <span>進行中</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #22c55e;"></div>
        <span>已完成</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #9ca3af;"></div>
        <span>尚未開始</span>
      </div>
      <div class="legend-item">
        <div class="legend-stripe"></div>
        <span>背景執行</span>
      </div>
      <div class="legend-item">
        <div class="legend-milestone"></div>
        <span>里程碑</span>
      </div>
      <div class="legend-item">
        <div style="width: 12px; height: 6px; background: rgba(245, 158, 11, 0.3); border-radius: 2px;"></div>
        <span>今天</span>
      </div>
    </div>
    <div class="sponsor">
      <span>Sponsored by</span>
      <iframe data-aa='2403226' src='//acceptable.a-ads.com/2403226' style='border:0; width:100px; height:16px; overflow:hidden; background-color: transparent;'></iframe>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="data.js"></script>
  <script>
    const state = {
      view: 'year',
      displayMode: 'day',
      selectedWeek: 4,
      today: new Date('2026-01-18')
    };

    const DAY_NAMES = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    const DAY_NAMES_WEEK = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

    function parseDate(str) {
      if (!str) return null;
      return new Date(str);
    }

    function formatDate(date, format = 'short') {
      if (!date) return '-';
      const d = new Date(date);
      if (format === 'short') {
        return `${d.getMonth() + 1}/${d.getDate()}`;
      }
      return d.toLocaleDateString('zh-TW');
    }

    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getWeekStartByNumber(year, weekNum) {
      const jan1 = new Date(year, 0, 1);
      const days = (weekNum - 1) * 7;
      const weekStart = new Date(jan1);
      weekStart.setDate(jan1.getDate() + days - jan1.getDay() + 1);
      return weekStart;
    }

    function getDaysBetween(start, end) {
      return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }

    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    function generateWeekOptions() {
      const select = document.getElementById('week-select');
      const year = SELAH_DATA.meta.year;
      select.innerHTML = '';

      for (let w = 1; w <= 52; w++) {
        const weekStart = getWeekStartByNumber(year, w);
        const option = document.createElement('option');
        option.value = w;
        option.textContent = `WK${String(w).padStart(2, '0')} (${weekStart.getMonth() + 1}/${weekStart.getDate()})`;
        select.appendChild(option);
      }

      select.value = state.selectedWeek;
    }

    function getAllTasks() {
      const tasks = [];
      SELAH_DATA.groups.forEach(group => {
        group.tasks.forEach(task => {
          tasks.push({
            ...task,
            groupId: group.id,
            groupName: group.name,
            groupColor: group.color
          });
        });
      });
      return tasks;
    }

    function isTaskActiveInWeek(task, weekStart, weekEnd) {
      if (!task.start || !task.end) return false;
      const taskStart = parseDate(task.start);
      const taskEnd = parseDate(task.end);
      return taskStart <= weekEnd && taskEnd >= weekStart;
    }

    function getYearDateRange() {
      const year = SELAH_DATA.meta.year;
      const start = new Date(year, 0, 1);
      const end = new Date(year, 11, 31);
      return { start, end };
    }

    function getWeekDateRange() {
      const weekStart = getWeekStartByNumber(SELAH_DATA.meta.year, state.selectedWeek);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      return { start: weekStart, end: weekEnd };
    }

    function render() {
      const table = document.getElementById('gantt-table');

      if (state.view === 'year') {
        table.className = state.displayMode === 'week' ? 'gantt-table year-week-view' : 'gantt-table';
        renderYearView(table);
      } else {
        table.className = 'gantt-table week-view';
        renderWeekView(table);
      }

      addEventListeners();
    }

    function renderYearView(table) {
      const { start, end } = getYearDateRange();
      const totalDays = getDaysBetween(start, end);

      let html = '<thead><tr>';
      html += '<th class="col-group">群組</th>';
      html += '<th class="col-task">專案</th>';

      if (state.displayMode === 'day') {
        for (let i = 0; i < totalDays; i++) {
          const date = new Date(start);
          date.setDate(date.getDate() + i);
          const isToday = isSameDay(date, state.today);
          const weekend = isWeekend(date);
          const dayName = DAY_NAMES[date.getDay()];

          html += `<th class="col-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
            <div class="day-header">
              <span class="day-name">${dayName}</span>
              <span class="day-num">${date.getDate()}${date.getDate() === 1 ? '/' + (date.getMonth() + 1) : ''}</span>
            </div>
          </th>`;
        }
      } else {
        const weeks = Math.ceil(totalDays / 7);
        for (let w = 0; w < weeks; w++) {
          const weekStart = new Date(start);
          weekStart.setDate(weekStart.getDate() + w * 7);
          const weekNum = getWeekNumber(weekStart);
          html += `<th class="col-day"><div class="day-header"><span class="day-name">W${weekNum}</span></div></th>`;
        }
      }

      html += '</tr></thead><tbody>';

      SELAH_DATA.groups.forEach(group => {
        const taskCount = group.tasks.length;

        group.tasks.forEach((task, idx) => {
          html += '<tr>';

          if (idx === 0) {
            html += `<td class="cell-group" rowspan="${taskCount}">
              <div class="group-label">
                <span class="group-color-bar" style="background: ${group.color}"></span>
                <span>${group.name}</span>
              </div>
            </td>`;
          }

          html += `<td class="cell-task ${task.status}" data-task-id="${task.id}">
            <div class="task-content">
              <span class="task-color-dot" style="background: ${group.color}"></span>
              <span class="task-status">${STATUS_CONFIG[task.status].icon}</span>
              <span class="task-name">${task.name}</span>
            </div>
          </td>`;

          html += renderDayCells(task, group, start, totalDays, state.displayMode);

          html += '</tr>';
        });
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    function renderWeekView(table) {
      const { start, end } = getWeekDateRange();

      let html = '<thead><tr>';
      html += '<th class="col-group">群組</th>';
      html += '<th class="col-task">專案</th>';

      for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(date.getDate() + i);
        const isToday = isSameDay(date, state.today);
        const weekend = isWeekend(date);

        html += `<th class="col-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
          <div class="day-header">
            <span class="day-name">${DAY_NAMES_WEEK[i]}</span>
            <span class="day-num">${date.getMonth() + 1}/${date.getDate()}</span>
          </div>
        </th>`;
      }

      html += '</tr></thead><tbody>';

      SELAH_DATA.groups.forEach(group => {
        const activeTasks = group.tasks.filter(task => {
          if (task.status === 'background') return true;
          return isTaskActiveInWeek(task, start, end);
        });

        if (activeTasks.length === 0) return;

        activeTasks.forEach((task, idx) => {
          html += '<tr>';

          if (idx === 0) {
            html += `<td class="cell-group" rowspan="${activeTasks.length}">
              <div class="group-label">
                <span class="group-color-bar" style="background: ${group.color}"></span>
                <span>${group.name}</span>
              </div>
            </td>`;
          }

          html += `<td class="cell-task ${task.status}" data-task-id="${task.id}">
            <div class="task-content">
              <span class="task-color-dot" style="background: ${group.color}"></span>
              <span class="task-status">${STATUS_CONFIG[task.status].icon}</span>
              <span class="task-name">${task.name}</span>
            </div>
          </td>`;

          html += renderWeekDayCells(task, group, start);

          html += '</tr>';
        });
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    function renderDayCells(task, group, rangeStart, totalDays, mode) {
      const cellWidth = mode === 'week' ? 16 : 21;
      const numCells = mode === 'week' ? Math.ceil(totalDays / 7) : totalDays;

      let html = '';
      let taskBarHtml = '';
      let milestoneHtml = '';

      if (task.start && task.end) {
        const taskStart = parseDate(task.start);
        const taskEnd = parseDate(task.end);

        let startCell, endCell;

        if (mode === 'week') {
          startCell = Math.floor((taskStart - rangeStart) / (7 * 24 * 60 * 60 * 1000));
          endCell = Math.floor((taskEnd - rangeStart) / (7 * 24 * 60 * 60 * 1000));
        } else {
          startCell = Math.floor((taskStart - rangeStart) / (24 * 60 * 60 * 1000));
          endCell = Math.floor((taskEnd - rangeStart) / (24 * 60 * 60 * 1000));
        }

        const barWidth = (endCell - startCell + 1) * cellWidth - 4;
        const isBackground = task.status === 'background';

        if (startCell >= 0 && startCell < numCells) {
          taskBarHtml = `<div class="task-bar ${task.status} ${isBackground ? 'background' : ''}"
               style="left: 2px; width: ${barWidth}px; background-color: ${group.color};"
               data-task-id="${task.id}"></div>`;
        }

        if (task.milestone) {
          const milestoneDate = parseDate(task.milestone);
          let milestoneCell;
          if (mode === 'week') {
            milestoneCell = Math.floor((milestoneDate - rangeStart) / (7 * 24 * 60 * 60 * 1000));
          } else {
            milestoneCell = Math.floor((milestoneDate - rangeStart) / (24 * 60 * 60 * 1000));
          }
          if (milestoneCell >= 0 && milestoneCell < numCells) {
            milestoneHtml = `<div class="milestone" style="left: ${cellWidth / 2}px;" data-task-id="${task.id}"></div>`;
          }
        }
      }

      for (let i = 0; i < numCells; i++) {
        const date = new Date(rangeStart);
        if (mode === 'week') {
          date.setDate(date.getDate() + i * 7);
        } else {
          date.setDate(date.getDate() + i);
        }
        const isToday = mode === 'day' && isSameDay(date, state.today);
        const weekend = mode === 'day' && isWeekend(date);

        let cellContent = '';

        if (task.start && task.end) {
          const taskStart = parseDate(task.start);
          const taskEnd = parseDate(task.end);
          let startCell, endCell, milestoneCell;

          if (mode === 'week') {
            startCell = Math.floor((taskStart - rangeStart) / (7 * 24 * 60 * 60 * 1000));
            endCell = Math.floor((taskEnd - rangeStart) / (7 * 24 * 60 * 60 * 1000));
          } else {
            startCell = Math.floor((taskStart - rangeStart) / (24 * 60 * 60 * 1000));
            endCell = Math.floor((taskEnd - rangeStart) / (24 * 60 * 60 * 1000));
          }

          if (i === startCell) {
            const barWidth = (endCell - startCell + 1) * cellWidth - 4;
            const isBackground = task.status === 'background';
            cellContent += `<div class="task-bar ${task.status} ${isBackground ? 'background' : ''}"
                 style="left: 2px; width: ${barWidth}px; background-color: ${group.color};"
                 data-task-id="${task.id}"></div>`;
          }

          if (task.milestone) {
            const milestoneDate = parseDate(task.milestone);
            if (mode === 'week') {
              milestoneCell = Math.floor((milestoneDate - rangeStart) / (7 * 24 * 60 * 60 * 1000));
            } else {
              milestoneCell = Math.floor((milestoneDate - rangeStart) / (24 * 60 * 60 * 1000));
            }
            if (i === milestoneCell) {
              cellContent += `<div class="milestone" style="left: ${cellWidth / 2}px;" data-task-id="${task.id}"></div>`;
            }
          }
        }

        html += `<td class="cell-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">${cellContent}</td>`;
      }

      return html;
    }

    function renderWeekDayCells(task, group, weekStart) {
      const cellWidth = 80;
      let html = '';

      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(date.getDate() + i);
        const isToday = isSameDay(date, state.today);
        const weekend = isWeekend(date);

        let cellContent = '';

        if (task.start && task.end) {
          const taskStart = parseDate(task.start);
          const taskEnd = parseDate(task.end);

          if (taskStart <= weekEnd && taskEnd >= weekStart) {
            const effectiveStart = taskStart < weekStart ? weekStart : taskStart;
            const effectiveEnd = taskEnd > weekEnd ? weekEnd : taskEnd;

            const startDay = Math.floor((effectiveStart - weekStart) / (24 * 60 * 60 * 1000));
            const endDay = Math.floor((effectiveEnd - weekStart) / (24 * 60 * 60 * 1000));

            if (i === startDay) {
              const barWidth = (endDay - startDay + 1) * cellWidth - 4;
              const isBackground = task.status === 'background';
              cellContent += `<div class="task-bar ${task.status} ${isBackground ? 'background' : ''}"
                   style="left: 2px; width: ${barWidth}px; background-color: ${group.color};"
                   data-task-id="${task.id}">${task.name}</div>`;
            }
          }

          if (task.milestone) {
            const milestoneDate = parseDate(task.milestone);
            if (milestoneDate >= weekStart && milestoneDate <= weekEnd) {
              const milestoneDay = Math.floor((milestoneDate - weekStart) / (24 * 60 * 60 * 1000));
              if (i === milestoneDay) {
                cellContent += `<div class="milestone" style="left: ${cellWidth / 2}px;" data-task-id="${task.id}"></div>`;
              }
            }
          }
        }

        html += `<td class="cell-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">${cellContent}</td>`;
      }

      return html;
    }

    function addEventListeners() {
      document.querySelectorAll('.task-bar, .milestone, .cell-task').forEach(el => {
        el.addEventListener('mouseenter', (e) => {
          const taskId = e.currentTarget.dataset.taskId;
          const task = getAllTasks().find(t => t.id === taskId);
          if (task) {
            showTooltip(e, task);
          }
        });
        el.addEventListener('mouseleave', hideTooltip);
      });
    }

    function showTooltip(e, task) {
      const tooltip = document.getElementById('tooltip');
      tooltip.innerHTML = `
        <div class="tooltip-title" style="color: ${task.groupColor}">${task.name}</div>
        <div class="tooltip-row"><span>分群：</span><span>${task.groupName}</span></div>
        <div class="tooltip-row"><span>狀態：</span><span>${STATUS_CONFIG[task.status].icon} ${STATUS_CONFIG[task.status].label}</span></div>
        <div class="tooltip-row"><span>開始：</span><span>${formatDate(task.start)}</span></div>
        <div class="tooltip-row"><span>結束：</span><span>${formatDate(task.end)}</span></div>
        ${task.milestone ? `<div class="tooltip-row"><span>里程碑：</span><span>${formatDate(task.milestone)}</span></div>` : ''}
        ${task.note ? `<div class="tooltip-row"><span>備註：</span><span>${task.note}</span></div>` : ''}
      `;

      const rect = e.currentTarget.getBoundingClientRect();
      tooltip.style.left = `${rect.left + 10}px`;
      tooltip.style.top = `${rect.bottom + 10}px`;
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      document.getElementById('tooltip').classList.remove('visible');
    }

    // Event Listeners
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        state.view = e.target.dataset.view;

        document.getElementById('year-controls').style.display = state.view === 'year' ? 'flex' : 'none';
        document.getElementById('week-selector').style.display = state.view === 'week' ? 'flex' : 'none';

        render();
      });
    });

    document.getElementById('display-mode').addEventListener('change', (e) => {
      state.displayMode = e.target.value;
      render();
    });

    document.getElementById('week-select').addEventListener('change', (e) => {
      state.selectedWeek = parseInt(e.target.value);
      render();
    });

    // Initialize
    document.getElementById('today-display').textContent = state.today.toLocaleDateString('zh-TW');
    generateWeekOptions();
    render();
  </script>
</body>
</html>
