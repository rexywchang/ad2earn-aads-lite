<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selah - Â∞àÊ°àÁîòÁâπÂúñ</title>
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #475569;
      --accent: #6366f1;
      --today: #f59e0b;
      --cell-width: 21px;
      --row-height: 22px;
      --group-col-width: 60px;
      --task-col-width: 120px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 0.67rem;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo h1 {
      font-size: 1rem;
      font-weight: 600;
    }

    .logo .subtitle {
      color: var(--text-secondary);
      font-size: 0.6rem;
    }

    .nav-tabs {
      display: flex;
      gap: 0.3rem;
    }

    .nav-tab {
      padding: 0.3rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 0.3rem;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.6rem;
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 0.6rem;
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .control-group label {
      color: var(--text-secondary);
      font-size: 0.6rem;
    }

    select {
      padding: 0.2rem 0.4rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.6rem;
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .cycle-btn-wrapper {
      position: relative;
      display: inline-block;
    }

    .cycle-btn {
      padding: 0.25rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 1rem;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.6rem;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 60px;
    }

    .cycle-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

    .cycle-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      display: none;
      z-index: 100;
      min-width: 80px;
      margin-top: 2px;
    }

    .cycle-dropdown.visible {
      display: block;
    }

    .save-btn {
      padding: 0.25rem 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.6rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .save-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

    /* Main Container */
    .main-container {
      flex: 1;
      overflow: auto;
      min-height: 0;
    }

    /* Gantt Table */
    .gantt-table {
      border-collapse: collapse;
      table-layout: fixed;
    }

    .gantt-table th,
    .gantt-table td {
      border: 1px solid var(--border-color);
      height: var(--row-height);
      vertical-align: middle;
      text-align: center;
    }

    /* Header row */
    .gantt-table thead {
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .gantt-table thead th {
      background: var(--bg-tertiary);
      font-weight: 600;
      font-size: 0.5rem;
      padding: 2px;
    }

    .gantt-table thead th.col-group {
      white-space: nowrap;
    }

    .gantt-table thead th.col-task {
      white-space: nowrap;
    }

    .gantt-table thead th.col-day {
      width: var(--cell-width);
      min-width: var(--cell-width);
    }

    .day-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      line-height: 1.1;
    }

    .day-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .day-num {
      font-size: 0.4rem;
      color: var(--text-secondary);
    }

    .col-day.weekend {
      background: rgba(255, 255, 255, 0.03);
    }

    .col-day.today {
      background: rgba(245, 158, 11, 0.2);
    }

    .col-day.today .day-name {
      color: var(--today);
    }

    /* Group cell (merged) */
    .cell-group {
      background: var(--bg-tertiary);
      font-size: 0.5rem;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 0;
      position: relative;
    }

    .group-color-bar {
      width: 4px;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
    }

    .group-name {
      padding: 2px 6px 2px 10px;
      white-space: nowrap;
    }

    .cell-group.dragging {
      opacity: 0.5;
    }

    .cell-group.drag-over {
      background: var(--accent);
    }

    /* Add buttons */
    .add-btn {
      background: transparent;
      border: 1px dashed var(--border-color);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.6rem;
      padding: 2px 6px;
      border-radius: 3px;
      transition: all 0.2s;
    }

    .add-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .header-with-add {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    /* Task cell */
    .cell-task {
      background: var(--bg-secondary);
      text-align: left;
      padding: 0 6px;
      font-size: 0.55rem;
      white-space: nowrap;
    }

    .cell-task .task-content {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .task-color-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .task-status {
      font-size: 0.45rem;
    }

    .task-name {
      white-space: nowrap;
    }

    .cell-task.completed {
      opacity: 0.6;
    }

    .cell-task.completed .task-name {
      text-decoration: line-through;
    }

    .cell-task.dragging {
      opacity: 0.5;
    }

    .cell-task.drag-over {
      background: var(--accent) !important;
    }

    /* Inline editing */
    .inline-input {
      background: var(--bg-primary);
      border: 1px solid var(--accent);
      color: var(--text-primary);
      font-size: 0.55rem;
      padding: 2px 4px;
      outline: none;
      width: auto;
    }

    /* Info icon */
    .info-icon {
      cursor: pointer;
      opacity: 0.5;
      font-size: 0.5rem;
      margin-left: 4px;
      transition: opacity 0.2s;
    }

    .info-icon:hover {
      opacity: 1;
    }

    /* Edit Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-overlay.visible {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      min-width: 300px;
      max-width: 400px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
      font-weight: 600;
      font-size: 0.7rem;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1rem;
      padding: 0;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .modal-field label {
      font-size: 0.55rem;
      color: var(--text-secondary);
    }

    .modal-field input,
    .modal-field select,
    .modal-field textarea {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      padding: 6px 8px;
      font-size: 0.55rem;
    }

    .modal-field textarea {
      resize: vertical;
      min-height: 60px;
    }

    .modal-field input:focus,
    .modal-field select:focus,
    .modal-field textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .modal-btn {
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 0.55rem;
      cursor: pointer;
      border: 1px solid var(--border-color);
    }

    .modal-btn-cancel {
      background: transparent;
      color: var(--text-secondary);
    }

    .modal-btn-save {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .modal-btn:hover {
      opacity: 0.8;
    }

    /* Delete Zone */
    .delete-zone {
      position: fixed;
      bottom: 50px;
      left: 16px;
      width: 80px;
      height: 80px;
      background: var(--bg-tertiary);
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 4px;
      font-size: 0.5rem;
      color: var(--text-secondary);
      transition: all 0.2s;
      z-index: 100;
    }

    .delete-zone-icon {
      font-size: 1.2rem;
    }

    .delete-zone.drag-over {
      background: #ef4444;
      border-color: #ef4444;
      color: white;
      transform: scale(1.1);
    }

    /* Day cells */
    .cell-day {
      background: var(--bg-primary);
      position: relative;
      width: var(--cell-width);
      min-width: var(--cell-width);
      padding: 0;
    }

    .cell-day.weekend {
      background: rgba(255, 255, 255, 0.02);
    }

    .cell-day.today {
      background: rgba(245, 158, 11, 0.1);
    }

    /* Task Bar */
    .task-bar {
      position: absolute;
      top: 2px;
      height: calc(var(--row-height) - 6px);
      border-radius: 3px;
      display: flex;
      align-items: center;
      padding: 0 4px;
      font-size: 0.45rem;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      z-index: 5;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      cursor: grab;
    }

    .task-bar:active {
      cursor: grabbing;
    }

    .task-bar.dragging {
      opacity: 0.6;
      cursor: grabbing;
    }

    .task-bar.completed {
      opacity: 0.7;
    }

    .task-bar .drag-handle {
      position: absolute;
      top: 0;
      width: 6px;
      height: 100%;
      cursor: ew-resize;
      background: rgba(255, 255, 255, 0.2);
      opacity: 0;
      transition: opacity 0.2s;
    }

    .task-bar:hover .drag-handle {
      opacity: 1;
    }

    .task-bar .drag-handle.left {
      left: 0;
      border-radius: 3px 0 0 3px;
    }

    .task-bar .drag-handle.right {
      right: 0;
      border-radius: 0 3px 3px 0;
    }

    /* Status toggle menu */
    .status-menu {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 4px 0;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
    }

    .status-menu.visible {
      display: block;
    }

    .status-menu-item {
      padding: 4px 12px;
      cursor: pointer;
      font-size: 0.55rem;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }

    .status-menu-item:hover {
      background: var(--bg-secondary);
    }

    .status-menu-item.active {
      background: var(--accent);
      color: white;
    }

    .task-bar.background {
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 3px,
        rgba(255,255,255,0.15) 3px,
        rgba(255,255,255,0.15) 6px
      );
    }


    /* Week View */
    .week-view .col-day,
    .week-view .cell-day {
      width: 80px;
      min-width: 80px;
    }

    .week-view thead th.col-day {
      width: 80px;
      min-width: 80px;
    }

    .week-view .day-header {
      padding: 4px;
    }

    .week-view .day-name {
      font-size: 0.55rem;
    }

    .week-view .day-num {
      font-size: 0.5rem;
    }

    /* Year Week Mode */
    .year-week-view .col-day,
    .year-week-view .cell-day {
      width: 16px;
      min-width: 16px;
    }

    .year-week-view thead th.col-day {
      width: 16px;
      min-width: 16px;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 0.3rem;
      padding: 0.5rem;
      font-size: 0.55rem;
      max-width: 200px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      display: none;
    }

    .tooltip.visible {
      display: block;
    }

    .tooltip-title {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.15rem;
      color: var(--text-secondary);
    }

    .tooltip-row span:last-child {
      color: var(--text-primary);
    }

    /* Footer */
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 1rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      font-size: 0.5rem;
      position: sticky;
      bottom: 0;
    }

    .legend {
      display: flex;
      gap: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--text-secondary);
    }

    .legend-color {
      width: 12px;
      height: 6px;
      border-radius: 2px;
    }

    .legend-stripe {
      width: 12px;
      height: 6px;
      border-radius: 2px;
      background: #3b82f6;
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 2px,
        rgba(255,255,255,0.3) 2px,
        rgba(255,255,255,0.3) 4px
      );
    }


    .sponsor {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .sponsor span {
      color: var(--text-secondary);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-color);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <h1>Selah</h1>
      <span class="subtitle">◊°÷∂◊ú÷∏◊î ‚Äî ÂÅú‰∏ãÔºåÊÄùËÄÉÔºåÂÜçÂâçË°å</span>
    </div>
    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="year">ÂÖ®Âπ¥ÁîòÁâπÂúñ</button>
      <button class="nav-tab" data-view="week">Âë®ÁîòÁâπÂúñ</button>
    </nav>
  </header>

  <div class="controls">
    <div class="control-group" id="year-controls">
      <div class="cycle-btn-wrapper">
        <button class="cycle-btn" id="display-mode-btn">Day</button>
        <select class="cycle-dropdown" id="display-mode-dropdown">
          <option value="day">Day</option>
          <option value="week">Week</option>
          <option value="biweek">Bi-Week</option>
          <option value="month">Month</option>
        </select>
      </div>
    </div>
    <div class="control-group" id="week-selector" style="display: none;">
      <div class="cycle-btn-wrapper">
        <button class="cycle-btn" id="week-select-btn">WK04</button>
        <select class="cycle-dropdown" id="week-select"></select>
      </div>
    </div>
    <div class="control-group">
      <label>‰ªäÂ§©Ôºö</label>
      <span id="today-display">2026-01-18</span>
    </div>
    <div class="control-group" style="margin-left: auto;">
      <button class="save-btn" id="sync-btn" onclick="syncFromFile()" title="Âæû data.json ÈáçÊñ∞ËºâÂÖ•ÔºàÊ∏ÖÈô§Êú¨Âú∞‰øÆÊîπÔºâ">üîÑ Sync</button>
      <button class="save-btn" id="export-btn" onclick="exportData()" title="Ë§áË£Ω JSON Âà∞Ââ™Ë≤ºÁ∞ø">üìã Copy</button>
    </div>
  </div>

  <div class="main-container">
    <table class="gantt-table" id="gantt-table"></table>
  </div>

  <div class="footer">
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #3b82f6;"></div>
        <span>ÈÅãË°å‰∏≠</span>
      </div>
      <div class="legend-item">
        <div class="legend-stripe"></div>
        <span>ËÉåÊôØÂü∑Ë°å</span>
      </div>
      <div class="legend-item">
        <div style="width: 12px; height: 6px; background: rgba(245, 158, 11, 0.3); border-radius: 2px;"></div>
        <span>‰ªäÂ§©</span>
      </div>
    </div>
    <div class="sponsor">
      <span>Sponsored by</span>
      <iframe data-aa='2403226' src='//acceptable.a-ads.com/2403226' style='border:0; width:100px; height:16px; overflow:hidden; background-color: transparent;'></iframe>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>
  <div class="status-menu" id="status-menu">
    <div class="status-menu-item" data-status="in_progress">üîµ ÈÅãË°å‰∏≠</div>
    <div class="status-menu-item" data-status="background">üî∑ ËÉåÊôØÂü∑Ë°å</div>
    <div class="status-menu-item" data-status="not_started">‚ö™ Êú™ÈñãÂßã</div>
  </div>

  <div class="delete-zone" id="delete-zone">
    <span class="delete-zone-icon">üóëÔ∏è</span>
    <span>Âà™Èô§</span>
  </div>

  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Á∑®ËºØÂ∞àÊ°à</span>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="modal-field">
          <label>ÂêçÁ®±</label>
          <input type="text" id="modal-name">
        </div>
        <div class="modal-field">
          <label>ÈñãÂßãÊó•Êúü</label>
          <input type="date" id="modal-start">
        </div>
        <div class="modal-field">
          <label>ÁµêÊùüÊó•Êúü</label>
          <input type="date" id="modal-end">
        </div>
        <div class="modal-field">
          <label>ÁãÄÊÖã</label>
          <select id="modal-status">
            <option value="in_progress">ÈÅãË°å‰∏≠</option>
            <option value="background">ËÉåÊôØÂü∑Ë°å</option>
            <option value="not_started">Êú™ÈñãÂßã</option>
          </select>
        </div>
        <div class="modal-field">
          <label>ÂÇôË®ª</label>
          <textarea id="modal-note"></textarea>
        </div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-cancel" onclick="closeModal()">ÂèñÊ∂à</button>
        <button class="modal-btn modal-btn-save" onclick="saveModal()">ÂÑ≤Â≠ò</button>
      </div>
    </div>
  </div>

  <script>
    // Data will be loaded from data.json
    let SELAH_DATA = { meta: {}, groups: [] };

    // Status configuration
    const STATUS_CONFIG = {
      in_progress: { label: "ÈÅãË°å‰∏≠", color: "#3b82f6", icon: "üîµ" },
      background: { label: "ËÉåÊôØÂü∑Ë°å", color: "#3b82f6", icon: "üî∑" },
      not_started: { label: "Êú™ÈñãÂßã", color: "#9ca3af", icon: "‚ö™" }
    };

    const state = {
      view: 'year',
      displayMode: 'day',
      selectedWeek: 4,
      today: new Date('2026-01-18')
    };

    const DAY_NAMES = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    const DAY_NAMES_WEEK = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

    function parseDate(str) {
      if (!str) return null;
      return new Date(str);
    }

    function formatDate(date, format = 'short') {
      if (!date) return '-';
      const d = new Date(date);
      if (format === 'short') {
        return `${d.getMonth() + 1}/${d.getDate()}`;
      }
      return d.toLocaleDateString('zh-TW');
    }

    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getWeekStartByNumber(year, weekNum) {
      const jan1 = new Date(year, 0, 1);
      const days = (weekNum - 1) * 7;
      const weekStart = new Date(jan1);
      weekStart.setDate(jan1.getDate() + days - jan1.getDay() + 1);
      return weekStart;
    }

    function getDaysBetween(start, end) {
      return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }

    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    function generateWeekOptions() {
      const select = document.getElementById('week-select');
      const year = SELAH_DATA.meta.year;
      select.innerHTML = '';

      for (let w = 1; w <= 52; w++) {
        const weekStart = getWeekStartByNumber(year, w);
        const option = document.createElement('option');
        option.value = w;
        option.textContent = `WK${String(w).padStart(2, '0')} (${weekStart.getMonth() + 1}/${weekStart.getDate()})`;
        select.appendChild(option);
      }

      select.value = state.selectedWeek;
    }

    function getAllTasks() {
      const tasks = [];
      SELAH_DATA.groups.forEach(group => {
        group.tasks.forEach(task => {
          tasks.push({
            ...task,
            groupId: group.id,
            groupName: group.name,
            groupColor: group.color
          });
        });
      });
      return tasks;
    }

    function isTaskActiveInWeek(task, weekStart, weekEnd) {
      if (!task.start || !task.end) return false;
      const taskStart = parseDate(task.start);
      const taskEnd = parseDate(task.end);
      return taskStart <= weekEnd && taskEnd >= weekStart;
    }

    function getYearDateRange() {
      const year = SELAH_DATA.meta.year;
      const start = new Date(year, 0, 1);
      const end = new Date(year, 11, 31);
      return { start, end };
    }

    function getWeekDateRange() {
      const weekStart = getWeekStartByNumber(SELAH_DATA.meta.year, state.selectedWeek);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      return { start: weekStart, end: weekEnd };
    }

    function render() {
      const table = document.getElementById('gantt-table');

      if (state.view === 'year') {
        table.className = state.displayMode === 'week' ? 'gantt-table year-week-view' : 'gantt-table';
        renderYearView(table);
      } else {
        table.className = 'gantt-table week-view';
        renderWeekView(table);
      }

      addEventListeners();
    }

    function renderYearView(table) {
      const { start, end } = getYearDateRange();
      const totalDays = getDaysBetween(start, end);

      let html = '<thead><tr>';
      html += '<th class="col-group"><div class="header-with-add">Áæ§ÁµÑ <button class="add-btn" onclick="addNewGroup()">+</button></div></th>';
      html += '<th class="col-task"><div class="header-with-add">Â∞àÊ°à <button class="add-btn" onclick="addNewTask()">+</button></div></th>';

      if (state.displayMode === 'day') {
        for (let i = 0; i < totalDays; i++) {
          const date = new Date(start);
          date.setDate(date.getDate() + i);
          const isToday = isSameDay(date, state.today);
          const weekend = isWeekend(date);
          const dayName = DAY_NAMES[date.getDay()];

          html += `<th class="col-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
            <div class="day-header">
              <span class="day-name">${dayName}</span>
              <span class="day-num">${date.getDate()}${date.getDate() === 1 ? '/' + (date.getMonth() + 1) : ''}</span>
            </div>
          </th>`;
        }
      } else if (state.displayMode === 'week') {
        const weeks = Math.ceil(totalDays / 7);
        for (let w = 0; w < weeks; w++) {
          const weekStart = new Date(start);
          weekStart.setDate(weekStart.getDate() + w * 7);
          const weekNum = getWeekNumber(weekStart);
          html += `<th class="col-day"><div class="day-header"><span class="day-name">W${weekNum}</span></div></th>`;
        }
      } else if (state.displayMode === 'biweek') {
        const biweeks = Math.ceil(totalDays / 14);
        for (let bw = 0; bw < biweeks; bw++) {
          const bwStart = new Date(start);
          bwStart.setDate(bwStart.getDate() + bw * 14);
          const weekNum = getWeekNumber(bwStart);
          html += `<th class="col-day"><div class="day-header"><span class="day-name">W${weekNum}-${weekNum + 1}</span></div></th>`;
        }
      } else if (state.displayMode === 'month') {
        const months = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
        for (let m = 0; m < 12; m++) {
          html += `<th class="col-day"><div class="day-header"><span class="day-name">${months[m]}</span></div></th>`;
        }
      }

      html += '</tr></thead><tbody>';

      SELAH_DATA.groups.forEach(group => {
        const taskCount = group.tasks.length;

        group.tasks.forEach((task, idx) => {
          html += '<tr>';

          if (idx === 0) {
            html += `<td class="cell-group" rowspan="${taskCount}" draggable="true" data-group-id="${group.id}">
              <span class="group-color-bar" style="background: ${group.color}"></span>
              <span class="group-name">${group.name}</span>
            </td>`;
          }

          const statusConfig = STATUS_CONFIG[task.status] || STATUS_CONFIG['in_progress'];
          html += `<td class="cell-task ${task.status}" data-task-id="${task.id}" data-group-id="${group.id}" draggable="true">
            <div class="task-content">
              <span class="task-color-dot" style="background: ${group.color}"></span>
              <span class="task-status">${statusConfig.icon}</span>
              <span class="task-name">${task.name}</span>
              <span class="info-icon" data-task-id="${task.id}" onclick="openModal('${task.id}')">‚Ñπ</span>
            </div>
          </td>`;

          html += renderDayCells(task, group, start, totalDays, state.displayMode);

          html += '</tr>';
        });
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    function renderWeekView(table) {
      const { start, end } = getWeekDateRange();

      let html = '<thead><tr>';
      html += '<th class="col-group"><div class="header-with-add">Áæ§ÁµÑ <button class="add-btn" onclick="addNewGroup()">+</button></div></th>';
      html += '<th class="col-task"><div class="header-with-add">Â∞àÊ°à <button class="add-btn" onclick="addNewTask()">+</button></div></th>';

      for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(date.getDate() + i);
        const isToday = isSameDay(date, state.today);
        const weekend = isWeekend(date);

        html += `<th class="col-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
          <div class="day-header">
            <span class="day-name">${DAY_NAMES_WEEK[i]}</span>
            <span class="day-num">${date.getMonth() + 1}/${date.getDate()}</span>
          </div>
        </th>`;
      }

      html += '</tr></thead><tbody>';

      SELAH_DATA.groups.forEach(group => {
        const activeTasks = group.tasks.filter(task => {
          if (task.status === 'background') return true;
          return isTaskActiveInWeek(task, start, end);
        });

        if (activeTasks.length === 0) return;

        activeTasks.forEach((task, idx) => {
          html += '<tr>';

          if (idx === 0) {
            html += `<td class="cell-group" rowspan="${activeTasks.length}" draggable="true" data-group-id="${group.id}">
              <span class="group-color-bar" style="background: ${group.color}"></span>
              <span class="group-name">${group.name}</span>
            </td>`;
          }

          const statusConfig = STATUS_CONFIG[task.status] || STATUS_CONFIG['in_progress'];
          html += `<td class="cell-task ${task.status}" data-task-id="${task.id}" data-group-id="${group.id}" draggable="true">
            <div class="task-content">
              <span class="task-color-dot" style="background: ${group.color}"></span>
              <span class="task-status">${statusConfig.icon}</span>
              <span class="task-name">${task.name}</span>
              <span class="info-icon" data-task-id="${task.id}" onclick="openModal('${task.id}')">‚Ñπ</span>
            </div>
          </td>`;

          html += renderWeekDayCells(task, group, start);

          html += '</tr>';
        });
      });

      html += '</tbody>';
      table.innerHTML = html;
    }

    function renderDayCells(task, group, rangeStart, totalDays, mode) {
      const cellWidth = mode === 'week' ? 16 : (mode === 'biweek' ? 8 : (mode === 'month' ? 4 : 21));
      const numCells = mode === 'week' ? Math.ceil(totalDays / 7) : (mode === 'biweek' ? Math.ceil(totalDays / 14) : (mode === 'month' ? 12 : totalDays));

      let html = '';

      for (let i = 0; i < numCells; i++) {
        const date = new Date(rangeStart);
        if (mode === 'week') {
          date.setDate(date.getDate() + i * 7);
        } else if (mode === 'biweek') {
          date.setDate(date.getDate() + i * 14);
        } else if (mode === 'month') {
          date.setMonth(date.getMonth() + i);
        } else {
          date.setDate(date.getDate() + i);
        }
        const isToday = mode === 'day' && isSameDay(date, state.today);
        const weekend = mode === 'day' && isWeekend(date);

        let cellContent = '';

        if (task.start && task.end) {
          const taskStart = parseDate(task.start);
          const taskEnd = parseDate(task.end);
          let startCell, endCell;

          if (mode === 'week') {
            startCell = Math.floor((taskStart - rangeStart) / (7 * 24 * 60 * 60 * 1000));
            endCell = Math.floor((taskEnd - rangeStart) / (7 * 24 * 60 * 60 * 1000));
          } else if (mode === 'biweek') {
            startCell = Math.floor((taskStart - rangeStart) / (14 * 24 * 60 * 60 * 1000));
            endCell = Math.floor((taskEnd - rangeStart) / (14 * 24 * 60 * 60 * 1000));
          } else if (mode === 'month') {
            startCell = taskStart.getMonth();
            endCell = taskEnd.getMonth();
          } else {
            startCell = Math.floor((taskStart - rangeStart) / (24 * 60 * 60 * 1000));
            endCell = Math.floor((taskEnd - rangeStart) / (24 * 60 * 60 * 1000));
          }

          if (i === startCell && task.status !== 'not_started') {
            const barWidth = (endCell - startCell + 1) * cellWidth - 4;
            const isBackground = task.status === 'background';
            cellContent += `<div class="task-bar ${task.status} ${isBackground ? 'background' : ''}"
                 style="left: 2px; width: ${barWidth}px; background-color: ${group.color};"
                 data-task-id="${task.id}">
                 <span class="drag-handle left" data-handle="start"></span>
                 <span class="drag-handle right" data-handle="end"></span>
            </div>`;
          }
        }

        html += `<td class="cell-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">${cellContent}</td>`;
      }

      return html;
    }

    function renderWeekDayCells(task, group, weekStart) {
      const cellWidth = 80;
      let html = '';

      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(date.getDate() + i);
        const isToday = isSameDay(date, state.today);
        const weekend = isWeekend(date);

        let cellContent = '';

        if (task.start && task.end) {
          const taskStart = parseDate(task.start);
          const taskEnd = parseDate(task.end);

          if (taskStart <= weekEnd && taskEnd >= weekStart) {
            const effectiveStart = taskStart < weekStart ? weekStart : taskStart;
            const effectiveEnd = taskEnd > weekEnd ? weekEnd : taskEnd;

            const startDay = Math.floor((effectiveStart - weekStart) / (24 * 60 * 60 * 1000));
            const endDay = Math.floor((effectiveEnd - weekStart) / (24 * 60 * 60 * 1000));

            if (i === startDay && task.status !== 'not_started') {
              const barWidth = (endDay - startDay + 1) * cellWidth - 4;
              const isBackground = task.status === 'background';
              cellContent += `<div class="task-bar ${task.status} ${isBackground ? 'background' : ''}"
                   style="left: 2px; width: ${barWidth}px; background-color: ${group.color};"
                   data-task-id="${task.id}">
                   <span class="drag-handle left" data-handle="start"></span>
                   ${task.name}
                   <span class="drag-handle right" data-handle="end"></span>
              </div>`;
            }
          }
        }

        html += `<td class="cell-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">${cellContent}</td>`;
      }

      return html;
    }

    let dragState = {
      type: null, // 'group' or 'task'
      sourceId: null,
      sourceGroupId: null
    };

    let resizeState = {
      active: false,
      taskId: null,
      handle: null,  // 'start', 'end', or 'move' (for whole bar drag)
      startX: null
    };

    function addEventListeners() {
      // Tooltip events
      document.querySelectorAll('.task-bar, .cell-task').forEach(el => {
        el.addEventListener('mouseenter', (e) => {
          const taskId = e.currentTarget.dataset.taskId;
          const task = getAllTasks().find(t => t.id === taskId);
          if (task) {
            showTooltip(e, task);
          }
        });
        el.addEventListener('mouseleave', hideTooltip);
      });

      // Group drag events
      document.querySelectorAll('.cell-group[draggable="true"]').forEach(el => {
        el.addEventListener('dragstart', handleGroupDragStart);
        el.addEventListener('dragend', handleGroupDragEnd);
        el.addEventListener('dragover', handleGroupDragOver);
        el.addEventListener('drop', handleGroupDrop);
        el.addEventListener('dragleave', handleGroupDragLeave);
      });

      // Task drag events
      document.querySelectorAll('.cell-task[draggable="true"]').forEach(el => {
        el.addEventListener('dragstart', handleTaskDragStart);
        el.addEventListener('dragend', handleTaskDragEnd);
      });

      // Task drop targets (group cells)
      document.querySelectorAll('.cell-group').forEach(el => {
        el.addEventListener('dragover', handleTaskDragOver);
        el.addEventListener('drop', handleTaskDrop);
        el.addEventListener('dragleave', handleTaskDragLeave);
      });

      // Task bar right-click for status menu and double-click to toggle
      document.querySelectorAll('.task-bar').forEach(el => {
        el.addEventListener('contextmenu', handleTaskBarContextMenu);
        el.addEventListener('dblclick', handleTaskBarDblClick);
        el.addEventListener('mousedown', handleBarMoveStart);
      });

      // Drag handles for resizing (stop propagation to prevent bar move)
      document.querySelectorAll('.drag-handle').forEach(el => {
        el.addEventListener('mousedown', handleResizeStart);
      });

      // Day cell click to set date for tasks without dates
      document.querySelectorAll('.cell-day').forEach(el => {
        el.addEventListener('click', handleDayCellClick);
      });

      // Double-click to edit group name
      document.querySelectorAll('.cell-group').forEach(el => {
        el.addEventListener('dblclick', handleGroupDblClick);
      });

      // Double-click to edit task name
      document.querySelectorAll('.cell-task').forEach(el => {
        el.addEventListener('dblclick', handleTaskDblClick);
      });
    }

    // Double-click handlers
    function handleGroupDblClick(e) {
      if (e.target.classList.contains('inline-input')) return;
      const groupId = e.currentTarget.dataset.groupId;
      const groupNameEl = e.currentTarget.querySelector('.group-name');
      if (groupNameEl) {
        makeEditable(groupNameEl, (newName) => {
          const group = SELAH_DATA.groups.find(g => g.id === groupId);
          if (group && newName) {
            group.name = newName;
            render();
            saveData();
          }
        });
      }
    }

    function handleTaskDblClick(e) {
      if (e.target.classList.contains('inline-input') || e.target.classList.contains('info-icon')) return;
      const taskId = e.currentTarget.dataset.taskId;
      const taskNameEl = e.currentTarget.querySelector('.task-name');
      if (taskNameEl) {
        makeEditable(taskNameEl, (newName) => {
          const task = findTaskById(taskId);
          if (task && newName) {
            task.name = newName;
            render();
            saveData();
          }
        });
      }
    }

    // Group drag handlers
    function handleGroupDragStart(e) {
      dragState.type = 'group';
      dragState.sourceId = e.currentTarget.dataset.groupId;
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleGroupDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.cell-group').forEach(el => el.classList.remove('drag-over'));
      dragState = { type: null, sourceId: null, sourceGroupId: null };
    }

    function handleGroupDragOver(e) {
      if (dragState.type !== 'group') return;
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function handleGroupDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleGroupDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      if (dragState.type !== 'group') return;

      const targetGroupId = e.currentTarget.dataset.groupId;
      if (targetGroupId === dragState.sourceId) return;

      const sourceIdx = SELAH_DATA.groups.findIndex(g => g.id === dragState.sourceId);
      const targetIdx = SELAH_DATA.groups.findIndex(g => g.id === targetGroupId);

      if (sourceIdx !== -1 && targetIdx !== -1) {
        const [removed] = SELAH_DATA.groups.splice(sourceIdx, 1);
        SELAH_DATA.groups.splice(targetIdx, 0, removed);
        render();
        saveData();
      }
    }

    // Task drag handlers
    function handleTaskDragStart(e) {
      e.stopPropagation();
      dragState.type = 'task';
      dragState.sourceId = e.currentTarget.dataset.taskId;
      dragState.sourceGroupId = e.currentTarget.dataset.groupId;
      e.currentTarget.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', dragState.sourceId);
    }

    function handleTaskDragEnd(e) {
      e.currentTarget.classList.remove('dragging');
      document.querySelectorAll('.cell-group').forEach(el => el.classList.remove('drag-over'));
      document.querySelectorAll('.cell-task').forEach(el => el.classList.remove('drag-over'));
      dragState = { type: null, sourceId: null, sourceGroupId: null };
    }

    function handleTaskDragOver(e) {
      if (dragState.type !== 'task') return;
      e.preventDefault();
      e.stopPropagation();
      const groupCell = e.currentTarget.closest('.cell-group') || e.currentTarget;
      groupCell.classList.add('drag-over');
    }

    function handleTaskDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleTaskDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.querySelectorAll('.cell-group').forEach(el => el.classList.remove('drag-over'));

      if (dragState.type !== 'task') return;

      // Find the target group ID from the cell
      const targetCell = e.currentTarget.closest('.cell-group') || e.currentTarget;
      const targetGroupId = targetCell.dataset.groupId;

      if (!targetGroupId || targetGroupId === dragState.sourceGroupId) return;

      // Find and move task
      const sourceGroup = SELAH_DATA.groups.find(g => g.id === dragState.sourceGroupId);
      const targetGroup = SELAH_DATA.groups.find(g => g.id === targetGroupId);

      if (sourceGroup && targetGroup) {
        const taskIdx = sourceGroup.tasks.findIndex(t => t.id === dragState.sourceId);
        if (taskIdx !== -1) {
          const [task] = sourceGroup.tasks.splice(taskIdx, 1);
          targetGroup.tasks.push(task);
          // Ensure source group still has at least one task
          ensureGroupHasTask(sourceGroup);
          // Sort by start date
          targetGroup.tasks.sort((a, b) => {
            if (!a.start) return 1;
            if (!b.start) return -1;
            return new Date(a.start) - new Date(b.start);
          });
          render();
          saveData();
        }
      }
    }

    // Task bar double-click to toggle status
    function handleTaskBarDblClick(e) {
      e.stopPropagation();
      const taskId = e.currentTarget.dataset.taskId;
      const task = findTaskById(taskId);
      if (task) {
        task.status = task.status === 'in_progress' ? 'background' : 'in_progress';
        render();
        saveData();
      }
    }

    // Day cell click to set date for not_started tasks or tasks without dates
    function handleDayCellClick(e) {
      const row = e.currentTarget.closest('tr');
      if (!row) return;

      const taskCell = row.querySelector('.cell-task');
      if (!taskCell) return;

      const taskId = taskCell.dataset.taskId;
      const task = findTaskById(taskId);

      // Only handle not_started tasks or tasks without dates
      if (task && (task.status === 'not_started' || !task.start || !task.end)) {
        const cellIndex = Array.from(row.children).indexOf(e.currentTarget);
        const dayIndex = cellIndex - 2; // Subtract group and task columns

        if (dayIndex >= 0) {
          let clickedDate;

          if (state.view === 'week') {
            // Week view: each cell is one day
            const { start } = getWeekDateRange();
            clickedDate = new Date(start);
            clickedDate.setDate(clickedDate.getDate() + dayIndex);
          } else {
            // Year view: depends on display mode
            const { start } = getYearDateRange();
            clickedDate = new Date(start);

            if (state.displayMode === 'week') {
              clickedDate.setDate(clickedDate.getDate() + dayIndex * 7);
            } else if (state.displayMode === 'biweek') {
              clickedDate.setDate(clickedDate.getDate() + dayIndex * 14);
            } else if (state.displayMode === 'month') {
              clickedDate.setMonth(clickedDate.getMonth() + dayIndex);
            } else {
              // day mode
              clickedDate.setDate(clickedDate.getDate() + dayIndex);
            }
          }

          const dateStr = clickedDate.toISOString().split('T')[0];
          task.start = dateStr;
          task.end = dateStr;
          task.status = 'in_progress';
          render();
          saveData();
        }
      }
    }

    // Status menu handlers
    function handleTaskBarContextMenu(e) {
      e.preventDefault();
      const taskId = e.currentTarget.dataset.taskId;
      const menu = document.getElementById('status-menu');

      // Update active state
      const task = getAllTasks().find(t => t.id === taskId);
      menu.querySelectorAll('.status-menu-item').forEach(item => {
        item.classList.toggle('active', item.dataset.status === task.status);
      });

      menu.dataset.taskId = taskId;
      menu.style.left = `${e.clientX}px`;
      menu.style.top = `${e.clientY}px`;
      menu.classList.add('visible');
    }

    // Bar move handler (drag whole bar to shift dates)
    function handleBarMoveStart(e) {
      // Ignore if clicking on drag handles
      if (e.target.classList.contains('drag-handle')) return;
      // Ignore right-click
      if (e.button !== 0) return;

      e.preventDefault();
      const taskBar = e.currentTarget;
      taskBar.classList.add('dragging');
      const style = window.getComputedStyle(taskBar);
      resizeState = {
        active: true,
        taskId: taskBar.dataset.taskId,
        handle: 'move',
        startX: e.clientX,
        element: taskBar,
        originalLeft: parseFloat(style.left) || 0,
        originalWidth: parseFloat(style.width) || 0
      };

      document.addEventListener('mousemove', handleResizeMove);
      document.addEventListener('mouseup', handleResizeEnd);
    }

    // Resize handlers (for drag handles)
    function handleResizeStart(e) {
      e.stopPropagation();
      e.preventDefault();
      const taskBar = e.target.closest('.task-bar');
      taskBar.classList.add('dragging');
      const style = window.getComputedStyle(taskBar);
      resizeState = {
        active: true,
        taskId: taskBar.dataset.taskId,
        handle: e.target.dataset.handle,
        startX: e.clientX,
        element: taskBar,
        originalLeft: parseFloat(style.left) || 0,
        originalWidth: parseFloat(style.width) || 0
      };

      document.addEventListener('mousemove', handleResizeMove);
      document.addEventListener('mouseup', handleResizeEnd);
    }

    function handleResizeMove(e) {
      if (!resizeState.active || !resizeState.element) return;
      e.preventDefault();

      const deltaX = e.clientX - resizeState.startX;
      const bar = resizeState.element;

      if (resizeState.handle === 'move') {
        // Move whole bar
        bar.style.left = (resizeState.originalLeft + deltaX) + 'px';
      } else if (resizeState.handle === 'start') {
        // Resize from left (adjust left and width)
        bar.style.left = (resizeState.originalLeft + deltaX) + 'px';
        bar.style.width = (resizeState.originalWidth - deltaX) + 'px';
      } else if (resizeState.handle === 'end') {
        // Resize from right (adjust width only)
        bar.style.width = (resizeState.originalWidth + deltaX) + 'px';
      }
    }

    function handleResizeEnd(e) {
      if (!resizeState.active) return;

      // Remove dragging visual effect
      if (resizeState.element) {
        resizeState.element.classList.remove('dragging');
      }

      const deltaX = e.clientX - resizeState.startX;
      const cellWidth = state.view === 'week' ? 80 : (state.displayMode === 'week' ? 16 : 21);
      const daysDelta = Math.round(deltaX / cellWidth);

      if (daysDelta !== 0) {
        const task = findTaskById(resizeState.taskId);
        if (task && task.start && task.end) {
          const startDate = new Date(task.start);
          const endDate = new Date(task.end);

          if (resizeState.handle === 'move') {
            // Move whole bar (shift both dates)
            startDate.setDate(startDate.getDate() + daysDelta);
            endDate.setDate(endDate.getDate() + daysDelta);
            task.start = startDate.toISOString().split('T')[0];
            task.end = endDate.toISOString().split('T')[0];
          } else if (resizeState.handle === 'start') {
            startDate.setDate(startDate.getDate() + daysDelta);
            if (startDate <= endDate) {
              task.start = startDate.toISOString().split('T')[0];
            }
          } else {
            endDate.setDate(endDate.getDate() + daysDelta);
            if (endDate >= startDate) {
              task.end = endDate.toISOString().split('T')[0];
            }
          }
          render();
          saveData();
        }
      }

      resizeState = { active: false, taskId: null, handle: null, startX: null, element: null };
      document.removeEventListener('mousemove', handleResizeMove);
      document.removeEventListener('mouseup', handleResizeEnd);
    }

    function findTaskById(taskId) {
      for (const group of SELAH_DATA.groups) {
        const task = group.tasks.find(t => t.id === taskId);
        if (task) return task;
      }
      return null;
    }

    // Ensure group always has at least one task
    function ensureGroupHasTask(group) {
      if (group.tasks.length === 0) {
        group.tasks.push({
          id: 'task-' + Date.now(),
          name: 'Êñ∞Â∞àÊ°à',
          start: null,
          end: null,
          status: 'not_started',
          note: ''
        });
      }
    }

    // Add new group (at bottom, with default task)
    function addNewGroup() {
      const groupId = 'group-' + Date.now();
      const taskId = 'task-' + Date.now();
      const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#06b6d4', '#ef4444'];
      const color = colors[SELAH_DATA.groups.length % colors.length];
      const today = state.today.toISOString().split('T')[0];

      SELAH_DATA.groups.push({
        id: groupId,
        name: 'Êñ∞Áæ§ÁµÑ',
        color: color,
        tasks: [{
          id: taskId,
          name: 'Êñ∞Â∞àÊ°à',
          start: today,
          end: today,
          status: 'in_progress',
          note: ''
        }]
      });

      render();
      saveData();

      // Make the new group name editable
      setTimeout(() => {
        const groupCell = document.querySelector(`[data-group-id="${groupId}"] .group-name`);
        if (groupCell) {
          makeEditable(groupCell, (newName) => {
            const group = SELAH_DATA.groups.find(g => g.id === groupId);
            if (group) {
              group.name = newName || 'Êñ∞Áæ§ÁµÑ';
              render();
              saveData();
            }
          });
        }
      }, 100);
    }

    // Add new task (to last group)
    function addNewTask() {
      if (SELAH_DATA.groups.length === 0) {
        alert('Ë´ãÂÖàÊñ∞Â¢ûÁæ§ÁµÑ');
        return;
      }

      const taskId = 'task-' + Date.now();
      const today = state.today.toISOString().split('T')[0];

      // Add to last group
      const lastGroup = SELAH_DATA.groups[SELAH_DATA.groups.length - 1];
      lastGroup.tasks.push({
        id: taskId,
        name: 'Êñ∞Â∞àÊ°à',
        start: today,
        end: today,
        status: 'in_progress',
        note: ''
      });

      render();
      saveData();

      // Make the new task name editable
      setTimeout(() => {
        const taskCell = document.querySelector(`[data-task-id="${taskId}"] .task-name`);
        if (taskCell) {
          makeEditable(taskCell, (newName) => {
            const task = findTaskById(taskId);
            if (task) {
              task.name = newName || 'Êñ∞Â∞àÊ°à';
              render();
              saveData();
            }
          });
        }
      }, 100);
    }

    function makeEditable(element, onSave) {
      const originalText = element.textContent;
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'inline-input';
      input.value = originalText;
      let cancelled = false;

      element.textContent = '';
      element.appendChild(input);
      input.focus();
      input.select();

      const save = () => {
        if (cancelled) {
          element.textContent = originalText;
          return;
        }
        const newValue = input.value.trim();
        element.textContent = newValue || originalText;
        onSave(newValue);
      };

      input.addEventListener('blur', save);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          input.blur();
        } else if (e.key === 'Escape') {
          cancelled = true;
          input.blur();
        }
      });
    }

    // Save data to localStorage
    function saveData() {
      localStorage.setItem('selahData', JSON.stringify(SELAH_DATA));
      console.log('Data saved to localStorage');
    }

    // Load data from data.json, then override with localStorage if exists
    async function loadData() {
      // First, load base data from data.json
      try {
        const response = await fetch('data.json');
        const jsonData = await response.json();
        SELAH_DATA.meta = jsonData.meta;
        SELAH_DATA.groups = jsonData.groups;
        console.log('Base data loaded from data.json');
      } catch (e) {
        console.error('Failed to load data.json:', e);
      }

      // Then, override with localStorage if exists
      const saved = localStorage.getItem('selahData');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          SELAH_DATA.groups = parsed.groups;
          SELAH_DATA.meta = parsed.meta;
          console.log('Data overridden from localStorage');
        } catch (e) {
          console.error('Failed to load saved data:', e);
        }
      }
    }

    // Sync from data.json (clear localStorage and reload)
    async function syncFromFile() {
      if (!confirm('Á¢∫ÂÆöË¶ÅÂæû data.json ÈáçÊñ∞ËºâÂÖ•ÂóéÔºüÊú¨Âú∞‰øÆÊîπÂ∞áË¢´Ë¶ÜËìã„ÄÇ')) return;

      localStorage.removeItem('selahData');

      try {
        const response = await fetch('data.json?' + Date.now()); // bust cache
        const jsonData = await response.json();
        SELAH_DATA.meta = jsonData.meta;
        SELAH_DATA.groups = jsonData.groups;

        const btn = document.getElementById('sync-btn');
        btn.textContent = '‚úì Synced!';
        setTimeout(() => {
          btn.textContent = 'üîÑ Sync';
        }, 2000);

        render();
      } catch (e) {
        alert('ÁÑ°Ê≥ïËºâÂÖ• data.json: ' + e.message);
      }
    }

    // Export as JSON (copy to clipboard)
    function exportData() {
      const exportObj = {
        meta: SELAH_DATA.meta,
        groups: SELAH_DATA.groups,
        exportedAt: new Date().toISOString()
      };
      const jsonStr = JSON.stringify(exportObj, null, 2);

      navigator.clipboard.writeText(jsonStr).then(() => {
        const btn = document.getElementById('export-btn');
        btn.textContent = '‚úì Copied!';
        setTimeout(() => {
          btn.textContent = 'üìã Copy';
        }, 2000);
      }).catch(() => {
        // Fallback: download as JSON file
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'selah-data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    // Modal functions
    let currentEditTaskId = null;

    function openModal(taskId) {
      currentEditTaskId = taskId;
      const task = findTaskById(taskId);
      if (!task) return;

      document.getElementById('modal-name').value = task.name || '';
      document.getElementById('modal-start').value = task.start || '';
      document.getElementById('modal-end').value = task.end || '';
      document.getElementById('modal-status').value = task.status || 'in_progress';
      document.getElementById('modal-note').value = task.note || '';

      document.getElementById('modal-overlay').classList.add('visible');
    }

    function closeModal() {
      currentEditTaskId = null;
      document.getElementById('modal-overlay').classList.remove('visible');
    }

    function saveModal() {
      if (!currentEditTaskId) return;
      const task = findTaskById(currentEditTaskId);
      if (!task) return;

      task.name = document.getElementById('modal-name').value;
      task.start = document.getElementById('modal-start').value || null;
      task.end = document.getElementById('modal-end').value || null;
      task.status = document.getElementById('modal-status').value;
      task.note = document.getElementById('modal-note').value;

      closeModal();
      render();
      saveData();
    }

    // Delete zone handlers
    function setupDeleteZone() {
      const deleteZone = document.getElementById('delete-zone');

      deleteZone.addEventListener('dragover', (e) => {
        if (dragState.type) {
          e.preventDefault();
          deleteZone.classList.add('drag-over');
        }
      });

      deleteZone.addEventListener('dragleave', () => {
        deleteZone.classList.remove('drag-over');
      });

      deleteZone.addEventListener('drop', (e) => {
        e.preventDefault();
        deleteZone.classList.remove('drag-over');

        if (dragState.type === 'group') {
          // Delete group
          const groupIdx = SELAH_DATA.groups.findIndex(g => g.id === dragState.sourceId);
          if (groupIdx !== -1) {
            if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Áæ§ÁµÑ„Äå${SELAH_DATA.groups[groupIdx].name}„ÄçÂèäÂÖ∂ÊâÄÊúâÂ∞àÊ°àÂóéÔºü`)) {
              SELAH_DATA.groups.splice(groupIdx, 1);
              render();
              saveData();
            }
          }
        } else if (dragState.type === 'task') {
          // Delete task
          const sourceGroup = SELAH_DATA.groups.find(g => g.id === dragState.sourceGroupId);
          if (sourceGroup) {
            const taskIdx = sourceGroup.tasks.findIndex(t => t.id === dragState.sourceId);
            if (taskIdx !== -1) {
              const taskName = sourceGroup.tasks[taskIdx].name;
              if (confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Â∞àÊ°à„Äå${taskName}„ÄçÂóéÔºü`)) {
                sourceGroup.tasks.splice(taskIdx, 1);
                // Ensure group still has at least one task
                ensureGroupHasTask(sourceGroup);
                render();
                saveData();
              }
            }
          }
        }

        dragState = { type: null, sourceId: null, sourceGroupId: null };
      });
    }

    function showTooltip(e, task) {
      const tooltip = document.getElementById('tooltip');
      const statusConfig = STATUS_CONFIG[task.status] || { icon: '‚ö™', label: 'Êú™Ë®≠ÂÆö' };
      tooltip.innerHTML = `
        <div class="tooltip-title" style="color: ${task.groupColor}">${task.name}</div>
        <div class="tooltip-row"><span>ÂàÜÁæ§Ôºö</span><span>${task.groupName}</span></div>
        <div class="tooltip-row"><span>ÁãÄÊÖãÔºö</span><span>${statusConfig.icon} ${statusConfig.label}</span></div>
        <div class="tooltip-row"><span>ÈñãÂßãÔºö</span><span>${formatDate(task.start)}</span></div>
        <div class="tooltip-row"><span>ÁµêÊùüÔºö</span><span>${formatDate(task.end)}</span></div>
        ${task.note ? `<div class="tooltip-row"><span>ÂÇôË®ªÔºö</span><span>${task.note}</span></div>` : ''}
      `;

      const rect = e.currentTarget.getBoundingClientRect();
      tooltip.style.left = `${rect.left + 10}px`;
      tooltip.style.top = `${rect.bottom + 10}px`;
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      document.getElementById('tooltip').classList.remove('visible');
    }

    // Event Listeners
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        state.view = e.target.dataset.view;

        document.getElementById('year-controls').style.display = state.view === 'year' ? 'flex' : 'none';
        document.getElementById('week-selector').style.display = state.view === 'week' ? 'flex' : 'none';

        render();
      });
    });

    // Display mode cycle button
    const displayModes = ['day', 'week', 'biweek', 'month'];
    const displayModeLabels = { day: 'Day', week: 'Week', biweek: 'Bi-Week', month: 'Month' };
    let displayModeClickTimer = null;

    document.getElementById('display-mode-btn').addEventListener('click', (e) => {
      if (displayModeClickTimer) {
        clearTimeout(displayModeClickTimer);
        displayModeClickTimer = null;
        // Double-click: show dropdown
        document.getElementById('display-mode-dropdown').classList.toggle('visible');
      } else {
        displayModeClickTimer = setTimeout(() => {
          displayModeClickTimer = null;
          // Single click: cycle to next
          const currentIdx = displayModes.indexOf(state.displayMode);
          state.displayMode = displayModes[(currentIdx + 1) % displayModes.length];
          document.getElementById('display-mode-btn').textContent = displayModeLabels[state.displayMode];
          render();
        }, 250);
      }
    });

    document.getElementById('display-mode-dropdown').addEventListener('change', (e) => {
      state.displayMode = e.target.value;
      document.getElementById('display-mode-btn').textContent = displayModeLabels[state.displayMode];
      document.getElementById('display-mode-dropdown').classList.remove('visible');
      render();
    });

    // Week selector cycle button
    let weekClickTimer = null;

    document.getElementById('week-select-btn').addEventListener('click', (e) => {
      if (weekClickTimer) {
        clearTimeout(weekClickTimer);
        weekClickTimer = null;
        // Double-click: show dropdown
        document.getElementById('week-select').classList.toggle('visible');
      } else {
        weekClickTimer = setTimeout(() => {
          weekClickTimer = null;
          // Single click: next week
          state.selectedWeek = (state.selectedWeek % 52) + 1;
          document.getElementById('week-select-btn').textContent = `WK${String(state.selectedWeek).padStart(2, '0')}`;
          document.getElementById('week-select').value = state.selectedWeek;
          render();
        }, 250);
      }
    });

    document.getElementById('week-select').addEventListener('change', (e) => {
      state.selectedWeek = parseInt(e.target.value);
      document.getElementById('week-select-btn').textContent = `WK${String(state.selectedWeek).padStart(2, '0')}`;
      document.getElementById('week-select').classList.remove('visible');
      render();
    });

    // Status menu click handlers
    document.getElementById('status-menu').addEventListener('click', (e) => {
      const item = e.target.closest('.status-menu-item');
      if (!item) return;

      const menu = document.getElementById('status-menu');
      const taskId = menu.dataset.taskId;
      const newStatus = item.dataset.status;

      const task = findTaskById(taskId);
      if (task) {
        task.status = newStatus;
        render();
        saveData();
      }

      menu.classList.remove('visible');
    });

    // Close status menu on click outside
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('status-menu');
      if (!menu.contains(e.target) && !e.target.closest('.task-bar')) {
        menu.classList.remove('visible');
      }
    });

    // Close modal on overlay click
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target === document.getElementById('modal-overlay')) {
        closeModal();
      }
    });

    // Initialize
    async function init() {
      await loadData(); // Load data from data.json, then localStorage
      document.getElementById('today-display').textContent = state.today.toLocaleDateString('zh-TW');
      generateWeekOptions();
      setupDeleteZone();
      render();
    }
    init();
  </script>
</body>
</html>
