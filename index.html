<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Selah - 專案甘特圖</title>
  <style>
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #475569;
      --accent: #6366f1;
      --today: #f59e0b;
      /* 縮小至 67% */
      --base-font: 0.67rem;
      --cell-width: 21px;
      --cell-height: 21px;
      --row-height: 24px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: var(--base-font);
      min-height: 100vh;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo h1 {
      font-size: 1rem;
      font-weight: 600;
    }

    .logo .subtitle {
      color: var(--text-secondary);
      font-size: 0.6rem;
    }

    /* Navigation */
    .nav-tabs {
      display: flex;
      gap: 0.3rem;
    }

    .nav-tab {
      padding: 0.3rem 0.6rem;
      border: 1px solid var(--border-color);
      border-radius: 0.3rem;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.6rem;
    }

    .nav-tab:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 0.6rem;
      padding: 0.5rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
      align-items: center;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .control-group label {
      color: var(--text-secondary);
      font-size: 0.6rem;
    }

    select {
      padding: 0.2rem 0.4rem;
      border: 1px solid var(--border-color);
      border-radius: 0.25rem;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 0.6rem;
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Main Container */
    .main-container {
      display: flex;
      height: calc(100vh - 70px);
      overflow: hidden;
    }

    /* Task List (Left Panel) */
    .task-list {
      width: 180px;
      min-width: 180px;
      border-right: 1px solid var(--border-color);
      background: var(--bg-secondary);
      display: flex;
      flex-direction: column;
    }

    .task-list-header {
      padding: 0.4rem 0.6rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      font-weight: 600;
      font-size: 0.6rem;
    }

    .task-list-content {
      flex: 1;
      overflow-y: auto;
    }

    .group-header {
      padding: 0.3rem 0.6rem;
      background: var(--bg-tertiary);
      font-weight: 600;
      font-size: 0.55rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.3rem;
      height: var(--row-height);
    }

    .group-color {
      width: 3px;
      height: 12px;
      border-radius: 1px;
    }

    .task-item {
      padding: 0.3rem 0.6rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.55rem;
      display: flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
      transition: background 0.15s;
      height: var(--row-height);
    }

    .task-item:hover {
      background: var(--bg-tertiary);
    }

    .task-item.completed {
      opacity: 0.6;
    }

    .task-item.completed .task-name {
      text-decoration: line-through;
    }

    .task-color-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .task-status {
      font-size: 0.5rem;
    }

    .task-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Gantt Chart (Right Panel) */
    .gantt-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .gantt-container {
      flex: 1;
      overflow: auto;
    }

    .gantt-chart {
      display: flex;
      flex-direction: column;
      min-width: max-content;
    }

    /* Timeline Header */
    .timeline-header {
      display: flex;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--bg-secondary);
    }

    .timeline-days {
      display: flex;
    }

    .timeline-day {
      width: var(--cell-width);
      min-width: var(--cell-width);
      text-align: center;
      padding: 0.15rem;
      border-bottom: 1px solid var(--border-color);
      border-right: 1px solid var(--border-color);
      font-size: 0.45rem;
      color: var(--text-secondary);
    }

    .timeline-day .day-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .timeline-day .day-num {
      font-size: 0.4rem;
    }

    .timeline-day.weekend {
      background: rgba(255, 255, 255, 0.03);
    }

    .timeline-day.today {
      background: rgba(245, 158, 11, 0.2);
    }

    .timeline-day.today .day-name {
      color: var(--today);
    }

    /* Gantt Rows */
    .gantt-body {
      display: flex;
      flex-direction: column;
    }

    .gantt-row {
      display: flex;
      height: var(--row-height);
      border-bottom: 1px solid var(--border-color);
      position: relative;
    }

    .gantt-row.group-row {
      background: var(--bg-tertiary);
    }

    .gantt-cell {
      width: var(--cell-width);
      min-width: var(--cell-width);
      border-right: 1px solid var(--border-color);
      position: relative;
    }

    .gantt-cell.weekend {
      background: rgba(255, 255, 255, 0.02);
    }

    .gantt-cell.today {
      background: rgba(245, 158, 11, 0.1);
    }

    /* Task Bar */
    .task-bar {
      position: absolute;
      top: 3px;
      height: 18px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      padding: 0 4px;
      font-size: 0.45rem;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      z-index: 5;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .task-bar.completed {
      opacity: 0.7;
    }

    /* 斜紋網底 - 背景執行 */
    .task-bar.background {
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 3px,
        rgba(255,255,255,0.15) 3px,
        rgba(255,255,255,0.15) 6px
      );
    }

    .milestone {
      position: absolute;
      top: 6px;
      width: 12px;
      height: 12px;
      transform: rotate(45deg) translateX(-50%);
      background: var(--today);
      z-index: 6;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* Week View Specific */
    .week-view .gantt-cell {
      width: 80px;
      min-width: 80px;
    }

    .week-view .timeline-day {
      width: 80px;
      min-width: 80px;
      padding: 0.3rem;
    }

    .week-view .timeline-day .day-name {
      font-size: 0.55rem;
    }

    .week-view .timeline-day .day-num {
      font-size: 0.5rem;
    }

    /* Year View - Week Mode */
    .year-week-view .gantt-cell {
      width: 16px;
      min-width: 16px;
    }

    .year-week-view .timeline-day {
      width: 16px;
      min-width: 16px;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 0.3rem;
      padding: 0.5rem;
      font-size: 0.55rem;
      max-width: 200px;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      display: none;
    }

    .tooltip.visible {
      display: block;
    }

    .tooltip-title {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.15rem;
      color: var(--text-secondary);
    }

    .tooltip-row span:last-child {
      color: var(--text-primary);
    }

    /* Legend & Footer */
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.4rem 1rem;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      font-size: 0.5rem;
    }

    .legend {
      display: flex;
      gap: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--text-secondary);
    }

    .legend-color {
      width: 12px;
      height: 6px;
      border-radius: 2px;
    }

    .legend-stripe {
      width: 12px;
      height: 6px;
      border-radius: 2px;
      background: #3b82f6;
      background-image: repeating-linear-gradient(
        45deg,
        transparent,
        transparent 2px,
        rgba(255,255,255,0.3) 2px,
        rgba(255,255,255,0.3) 4px
      );
    }

    .legend-milestone {
      width: 6px;
      height: 6px;
      transform: rotate(45deg);
      background: var(--today);
    }

    .sponsor {
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .sponsor span {
      color: var(--text-secondary);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--border-color);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <h1>Selah</h1>
      <span class="subtitle">סֶלָה — 停下，思考，再前行</span>
    </div>
    <nav class="nav-tabs">
      <button class="nav-tab active" data-view="year">全年甘特圖</button>
      <button class="nav-tab" data-view="week">周甘特圖</button>
    </nav>
  </header>

  <div class="controls">
    <div class="control-group" id="year-controls">
      <label>顯示：</label>
      <select id="display-mode">
        <option value="day">按天</option>
        <option value="week">按周</option>
      </select>
    </div>
    <div class="control-group">
      <label>排序：</label>
      <select id="sort-mode">
        <option value="group">按分群</option>
        <option value="start">按開始日期</option>
      </select>
    </div>
    <div class="control-group" id="week-selector" style="display: none;">
      <label>選擇周：</label>
      <select id="week-select"></select>
    </div>
    <div class="control-group">
      <label>今天：</label>
      <span id="today-display">2026-01-18</span>
    </div>
  </div>

  <div class="main-container">
    <div class="task-list">
      <div class="task-list-header">專案列表</div>
      <div class="task-list-content" id="task-list-content"></div>
    </div>
    <div class="gantt-wrapper">
      <div class="gantt-container" id="gantt-container">
        <div class="gantt-chart" id="gantt-chart"></div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #3b82f6;"></div>
        <span>進行中</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #22c55e;"></div>
        <span>已完成</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #9ca3af;"></div>
        <span>尚未開始</span>
      </div>
      <div class="legend-item">
        <div class="legend-stripe"></div>
        <span>背景執行</span>
      </div>
      <div class="legend-item">
        <div class="legend-milestone"></div>
        <span>里程碑</span>
      </div>
      <div class="legend-item">
        <div style="width: 12px; height: 6px; background: rgba(245, 158, 11, 0.3); border-radius: 2px;"></div>
        <span>今天</span>
      </div>
    </div>
    <div class="sponsor">
      <span>Sponsored by</span>
      <iframe data-aa='2403226' src='//acceptable.a-ads.com/2403226' style='border:0; width:100px; height:16px; overflow:hidden; background-color: transparent;'></iframe>
    </div>
  </div>

  <div class="tooltip" id="tooltip"></div>

  <script src="data.js"></script>
  <script>
    // Global State
    const state = {
      view: 'year',
      displayMode: 'day',
      sortMode: 'group',
      selectedWeek: 4, // Week number
      today: new Date('2026-01-18')
    };

    const DAY_NAMES = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
    const DAY_NAMES_WEEK = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

    // Utility Functions
    function parseDate(str) {
      if (!str) return null;
      return new Date(str);
    }

    function formatDate(date, format = 'short') {
      if (!date) return '-';
      const d = new Date(date);
      if (format === 'short') {
        return `${d.getMonth() + 1}/${d.getDate()}`;
      }
      return d.toLocaleDateString('zh-TW');
    }

    function getWeekNumber(date) {
      const d = new Date(date);
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function getWeekStartByNumber(year, weekNum) {
      const jan1 = new Date(year, 0, 1);
      const days = (weekNum - 1) * 7;
      const weekStart = new Date(jan1);
      weekStart.setDate(jan1.getDate() + days - jan1.getDay() + 1);
      return weekStart;
    }

    function getWeekStart(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff));
    }

    function getDaysBetween(start, end) {
      return Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    }

    function isSameDay(d1, d2) {
      return d1.getFullYear() === d2.getFullYear() &&
             d1.getMonth() === d2.getMonth() &&
             d1.getDate() === d2.getDate();
    }

    function isWeekend(date) {
      const day = date.getDay();
      return day === 0 || day === 6;
    }

    // Generate week options
    function generateWeekOptions() {
      const select = document.getElementById('week-select');
      const year = SELAH_DATA.meta.year;
      select.innerHTML = '';

      for (let w = 1; w <= 52; w++) {
        const weekStart = getWeekStartByNumber(year, w);
        const option = document.createElement('option');
        option.value = w;
        option.textContent = `WK${String(w).padStart(2, '0')} (${weekStart.getMonth() + 1}/${weekStart.getDate()})`;
        select.appendChild(option);
      }

      select.value = state.selectedWeek;
    }

    // Get all tasks flattened with group info
    function getAllTasks() {
      const tasks = [];
      SELAH_DATA.groups.forEach(group => {
        group.tasks.forEach(task => {
          tasks.push({
            ...task,
            groupId: group.id,
            groupName: group.name,
            groupColor: group.color
          });
        });
      });
      return tasks;
    }

    // Check if task is active in a given week
    function isTaskActiveInWeek(task, weekStart, weekEnd) {
      if (!task.start || !task.end) return false;
      const taskStart = parseDate(task.start);
      const taskEnd = parseDate(task.end);
      // Task overlaps with week
      return taskStart <= weekEnd && taskEnd >= weekStart;
    }

    // Sort tasks
    function sortTasks(tasks, mode) {
      if (mode === 'start') {
        return [...tasks].sort((a, b) => {
          if (!a.start && !b.start) return 0;
          if (!a.start) return 1;
          if (!b.start) return -1;
          return new Date(a.start) - new Date(b.start);
        });
      }
      return tasks;
    }

    // Render Task List
    function renderTaskList() {
      const container = document.getElementById('task-list-content');
      container.innerHTML = '';

      const tasksToShow = getTasksForCurrentView();

      if (state.sortMode === 'group') {
        SELAH_DATA.groups.forEach(group => {
          const groupTasks = tasksToShow.filter(t => t.groupId === group.id);
          if (groupTasks.length === 0 && state.view === 'week') return;

          // Group header
          const groupHeader = document.createElement('div');
          groupHeader.className = 'group-header';
          groupHeader.innerHTML = `
            <div class="group-color" style="background: ${group.color}"></div>
            ${group.name}
          `;
          container.appendChild(groupHeader);

          // Tasks
          const tasks = state.view === 'week' ? groupTasks : group.tasks;
          tasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = `task-item ${task.status}`;
            taskItem.innerHTML = `
              <div class="task-color-dot" style="background: ${group.color}"></div>
              <span class="task-status">${STATUS_CONFIG[task.status].icon}</span>
              <span class="task-name">${task.name}</span>
            `;
            taskItem.addEventListener('mouseenter', (e) => showTooltip(e, task, group));
            taskItem.addEventListener('mouseleave', hideTooltip);
            container.appendChild(taskItem);
          });
        });
      } else {
        const allTasks = sortTasks(tasksToShow, 'start');
        allTasks.forEach(task => {
          const taskItem = document.createElement('div');
          taskItem.className = `task-item ${task.status}`;
          taskItem.innerHTML = `
            <div class="task-color-dot" style="background: ${task.groupColor}"></div>
            <span class="task-status">${STATUS_CONFIG[task.status].icon}</span>
            <span class="task-name">${task.name}</span>
          `;
          taskItem.addEventListener('mouseenter', (e) => showTooltip(e, task, { color: task.groupColor, name: task.groupName }));
          taskItem.addEventListener('mouseleave', hideTooltip);
          container.appendChild(taskItem);
        });
      }
    }

    // Get tasks for current view
    function getTasksForCurrentView() {
      const allTasks = getAllTasks();

      if (state.view === 'year') {
        return allTasks;
      } else {
        // Week view - only show tasks active in selected week
        const weekStart = getWeekStartByNumber(SELAH_DATA.meta.year, state.selectedWeek);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        return allTasks.filter(task => {
          if (task.status === 'background') return true; // Always show background tasks
          return isTaskActiveInWeek(task, weekStart, weekEnd);
        });
      }
    }

    // Generate date range for year view
    function getYearDateRange() {
      const year = SELAH_DATA.meta.year;
      const start = new Date(year, 0, 1);
      const end = new Date(year, 11, 31);
      return { start, end };
    }

    // Generate date range for week view
    function getWeekDateRange() {
      const weekStart = getWeekStartByNumber(SELAH_DATA.meta.year, state.selectedWeek);
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      return { start: weekStart, end: weekEnd };
    }

    // Render Year View
    function renderYearView() {
      const chart = document.getElementById('gantt-chart');
      chart.className = state.displayMode === 'week' ? 'gantt-chart year-week-view' : 'gantt-chart';

      const { start, end } = getYearDateRange();
      const totalDays = getDaysBetween(start, end);

      let html = '<div class="timeline-header"><div class="timeline-days">';

      // Generate timeline header
      if (state.displayMode === 'day') {
        for (let i = 0; i < totalDays; i++) {
          const date = new Date(start);
          date.setDate(date.getDate() + i);
          const isToday = isSameDay(date, state.today);
          const weekend = isWeekend(date);
          const dayName = DAY_NAMES[date.getDay()];

          html += `<div class="timeline-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
            <div class="day-name">${dayName}</div>
            <div class="day-num">${date.getDate()}${date.getDate() === 1 ? '/' + (date.getMonth() + 1) : ''}</div>
          </div>`;
        }
      } else {
        const weeks = Math.ceil(totalDays / 7);
        for (let w = 0; w < weeks; w++) {
          const weekStart = new Date(start);
          weekStart.setDate(weekStart.getDate() + w * 7);
          const weekNum = getWeekNumber(weekStart);
          html += `<div class="timeline-day"><div class="day-name">W${weekNum}</div></div>`;
        }
      }

      html += '</div></div>';

      // Render rows
      html += '<div class="gantt-body">';

      if (state.sortMode === 'group') {
        SELAH_DATA.groups.forEach(group => {
          // Group row
          html += `<div class="gantt-row group-row">`;
          if (state.displayMode === 'day') {
            for (let i = 0; i < totalDays; i++) {
              const date = new Date(start);
              date.setDate(date.getDate() + i);
              const isToday = isSameDay(date, state.today);
              const weekend = isWeekend(date);
              html += `<div class="gantt-cell ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}"></div>`;
            }
          } else {
            const weeks = Math.ceil(totalDays / 7);
            for (let w = 0; w < weeks; w++) {
              html += `<div class="gantt-cell"></div>`;
            }
          }
          html += '</div>';

          // Task rows
          group.tasks.forEach(task => {
            html += renderTaskRow(task, group, start, totalDays);
          });
        });
      } else {
        const allTasks = sortTasks(getAllTasks(), 'start');
        allTasks.forEach(task => {
          html += renderTaskRow(task, { color: task.groupColor }, start, totalDays);
        });
      }

      html += '</div>';
      chart.innerHTML = html;

      addTaskBarListeners();
    }

    // Render single task row
    function renderTaskRow(task, group, rangeStart, totalDays) {
      const cellWidth = state.displayMode === 'week' ? 16 : 21;
      const numCells = state.displayMode === 'week' ? Math.ceil(totalDays / 7) : totalDays;

      let html = `<div class="gantt-row">`;

      for (let i = 0; i < numCells; i++) {
        const date = new Date(rangeStart);
        if (state.displayMode === 'week') {
          date.setDate(date.getDate() + i * 7);
        } else {
          date.setDate(date.getDate() + i);
        }
        const isToday = state.displayMode === 'day' && isSameDay(date, state.today);
        const weekend = state.displayMode === 'day' && isWeekend(date);
        html += `<div class="gantt-cell ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}"></div>`;
      }

      // Add task bar if has dates
      if (task.start && task.end) {
        const taskStart = parseDate(task.start);
        const taskEnd = parseDate(task.end);

        let startOffset, barWidth;

        if (state.displayMode === 'week') {
          const startWeek = Math.floor((taskStart - rangeStart) / (7 * 24 * 60 * 60 * 1000));
          const endWeek = Math.floor((taskEnd - rangeStart) / (7 * 24 * 60 * 60 * 1000));
          startOffset = startWeek * cellWidth;
          barWidth = (endWeek - startWeek + 1) * cellWidth - 2;
        } else {
          const startDay = Math.floor((taskStart - rangeStart) / (24 * 60 * 60 * 1000));
          const duration = getDaysBetween(taskStart, taskEnd);
          startOffset = startDay * cellWidth;
          barWidth = duration * cellWidth - 2;
        }

        if (startOffset >= 0 && barWidth > 0) {
          const isBackground = task.status === 'background';
          html = html.replace('</div><!--END-->', '');
          html += `
            <div class="task-bar ${task.status} ${isBackground ? 'background' : ''}"
                 style="left: ${startOffset + 1}px; width: ${barWidth}px; background-color: ${group.color};"
                 data-task-id="${task.id}">
            </div>`;
        }

        // Add milestone
        if (task.milestone) {
          const milestoneDate = parseDate(task.milestone);
          let milestoneOffset;
          if (state.displayMode === 'week') {
            const milestoneWeek = Math.floor((milestoneDate - rangeStart) / (7 * 24 * 60 * 60 * 1000));
            milestoneOffset = milestoneWeek * cellWidth + cellWidth / 2;
          } else {
            const milestoneDay = Math.floor((milestoneDate - rangeStart) / (24 * 60 * 60 * 1000));
            milestoneOffset = milestoneDay * cellWidth + cellWidth / 2;
          }
          html += `<div class="milestone" style="left: ${milestoneOffset}px;" data-task-id="${task.id}"></div>`;
        }
      }

      html += '</div>';
      return html;
    }

    // Render Week View
    function renderWeekView() {
      const chart = document.getElementById('gantt-chart');
      chart.className = 'gantt-chart week-view';

      const { start, end } = getWeekDateRange();

      let html = '<div class="timeline-header"><div class="timeline-days">';

      // Generate day headers with M T W T F S S
      for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(date.getDate() + i);
        const isToday = isSameDay(date, state.today);
        const weekend = isWeekend(date);

        html += `<div class="timeline-day ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}">
          <div class="day-name">${DAY_NAMES_WEEK[i]}</div>
          <div class="day-num">${date.getMonth() + 1}/${date.getDate()}</div>
        </div>`;
      }

      html += '</div></div>';

      // Render rows
      html += '<div class="gantt-body">';

      const tasksToShow = getTasksForCurrentView();

      if (state.sortMode === 'group') {
        SELAH_DATA.groups.forEach(group => {
          const groupTasks = tasksToShow.filter(t => t.groupId === group.id);
          if (groupTasks.length === 0) return;

          groupTasks.forEach(task => {
            html += renderWeekTaskRow(task, group, start);
          });
        });
      } else {
        const sortedTasks = sortTasks(tasksToShow, 'start');
        sortedTasks.forEach(task => {
          html += renderWeekTaskRow(task, { color: task.groupColor }, start);
        });
      }

      html += '</div>';
      chart.innerHTML = html;

      addTaskBarListeners();
    }

    // Render week task row
    function renderWeekTaskRow(task, group, weekStart) {
      const cellWidth = 80;
      let html = '<div class="gantt-row">';

      for (let i = 0; i < 7; i++) {
        const date = new Date(weekStart);
        date.setDate(date.getDate() + i);
        const isToday = isSameDay(date, state.today);
        const weekend = isWeekend(date);
        html += `<div class="gantt-cell ${weekend ? 'weekend' : ''} ${isToday ? 'today' : ''}"></div>`;
      }

      // Add task bar
      if (task.start && task.end) {
        const taskStart = parseDate(task.start);
        const taskEnd = parseDate(task.end);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);

        if (taskStart <= weekEnd && taskEnd >= weekStart) {
          const effectiveStart = taskStart < weekStart ? weekStart : taskStart;
          const effectiveEnd = taskEnd > weekEnd ? weekEnd : taskEnd;

          const startDay = Math.floor((effectiveStart - weekStart) / (24 * 60 * 60 * 1000));
          const endDay = Math.floor((effectiveEnd - weekStart) / (24 * 60 * 60 * 1000));

          const startOffset = startDay * cellWidth;
          const barWidth = (endDay - startDay + 1) * cellWidth - 4;

          const isBackground = task.status === 'background';
          html += `
            <div class="task-bar ${task.status} ${isBackground ? 'background' : ''}"
                 style="left: ${startOffset + 2}px; width: ${barWidth}px; background-color: ${group.color};"
                 data-task-id="${task.id}">
              ${task.name}
            </div>`;
        }

        // Add milestone if in this week
        if (task.milestone) {
          const milestoneDate = parseDate(task.milestone);
          if (milestoneDate >= weekStart && milestoneDate <= weekEnd) {
            const milestoneDay = Math.floor((milestoneDate - weekStart) / (24 * 60 * 60 * 1000));
            const milestoneOffset = milestoneDay * cellWidth + cellWidth / 2;
            html += `<div class="milestone" style="left: ${milestoneOffset}px;" data-task-id="${task.id}"></div>`;
          }
        }
      }

      html += '</div>';
      return html;
    }

    // Add event listeners to task bars
    function addTaskBarListeners() {
      document.querySelectorAll('.task-bar, .milestone').forEach(el => {
        el.addEventListener('mouseenter', (e) => {
          const taskId = e.target.dataset.taskId;
          const task = getAllTasks().find(t => t.id === taskId);
          if (task) {
            showTooltip(e, task, { color: task.groupColor, name: task.groupName });
          }
        });
        el.addEventListener('mouseleave', hideTooltip);
      });
    }

    // Tooltip
    function showTooltip(e, task, group) {
      const tooltip = document.getElementById('tooltip');
      tooltip.innerHTML = `
        <div class="tooltip-title" style="color: ${group.color}">${task.name}</div>
        <div class="tooltip-row"><span>分群：</span><span>${group.name || task.groupName}</span></div>
        <div class="tooltip-row"><span>狀態：</span><span>${STATUS_CONFIG[task.status].icon} ${STATUS_CONFIG[task.status].label}</span></div>
        <div class="tooltip-row"><span>開始：</span><span>${formatDate(task.start)}</span></div>
        <div class="tooltip-row"><span>結束：</span><span>${formatDate(task.end)}</span></div>
        ${task.milestone ? `<div class="tooltip-row"><span>里程碑：</span><span>${formatDate(task.milestone)}</span></div>` : ''}
        ${task.note ? `<div class="tooltip-row"><span>備註：</span><span>${task.note}</span></div>` : ''}
      `;

      const rect = e.target.getBoundingClientRect();
      tooltip.style.left = `${rect.left + 10}px`;
      tooltip.style.top = `${rect.bottom + 10}px`;
      tooltip.classList.add('visible');
    }

    function hideTooltip() {
      document.getElementById('tooltip').classList.remove('visible');
    }

    // Sync scroll between task list and gantt
    function syncScroll() {
      const taskList = document.querySelector('.task-list-content');
      const ganttContainer = document.getElementById('gantt-container');

      ganttContainer.addEventListener('scroll', () => {
        taskList.scrollTop = ganttContainer.scrollTop;
      });

      taskList.addEventListener('scroll', () => {
        ganttContainer.scrollTop = taskList.scrollTop;
      });
    }

    // Render based on current state
    function render() {
      renderTaskList();
      if (state.view === 'year') {
        renderYearView();
      } else {
        renderWeekView();
      }
    }

    // Event Listeners
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        state.view = e.target.dataset.view;

        document.getElementById('year-controls').style.display = state.view === 'year' ? 'flex' : 'none';
        document.getElementById('week-selector').style.display = state.view === 'week' ? 'flex' : 'none';

        render();
      });
    });

    document.getElementById('display-mode').addEventListener('change', (e) => {
      state.displayMode = e.target.value;
      render();
    });

    document.getElementById('sort-mode').addEventListener('change', (e) => {
      state.sortMode = e.target.value;
      render();
    });

    document.getElementById('week-select').addEventListener('change', (e) => {
      state.selectedWeek = parseInt(e.target.value);
      render();
    });

    // Initialize
    document.getElementById('today-display').textContent = state.today.toLocaleDateString('zh-TW');
    generateWeekOptions();
    syncScroll();
    render();
  </script>
</body>
</html>
